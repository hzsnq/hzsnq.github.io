import{a as e,_ as t,b as s}from"./NavBar.c3c1f6a6.js";import{s as i,P as l,$ as o,Q as a,R as n,b as h,c as r,w as d,e as p,T as u,U as c,f as g,j as f,V as m,W as y,X as b,Y as _,E as w,G as j,h as S,F,i as O,q as v,d as x,r as I,n as N,g as T,u as z,l as C}from"./index-5c3c44fe.js";import{_ as U}from"./download.6031f376.js";class D{constructor(e){this.dom=null,this.files=new Map,this.debug=e.debug||!1,this.id=e.id,this.width=e.width,this.height=e.height,this.option=e.option,this.instantly=e.instantly,this.prohibited=e.prohibited,this.onchange=e.onchange,this.onprogress=e.onprogress,this.uploadHandle=this._uploadHandle}create(e){if(!this.dom){let e=document.createElement("input");return e.type="file",e.value="",e.style.height=this.height,e.style.width=this.width,e.style.position="absolute",e.style.top=0,e.style.left=0,e.style.right=0,e.style.bottom=0,e.style.opacity=0,e.style.zIndex=999,e.accept=this.prohibited.accept,this.prohibited.multiple&&(e.multiple="multiple"),e.onchange=e=>{for(let t of e.target.files){if(this.files.size>=this.prohibited.count){this.toast(`只允许上传${this.prohibited.count}个文件`),this.dom.value="";break}this.addFile(t)}this._uploadAfter(),this.dom.value=""},this.dom=e,this.dom}}setData(){let[e,t=""]=arguments;"object"==typeof e?Object.assign(this.option,e):this._setValue(this.option,e,t),this.debug&&console.log(JSON.stringify(this.option))}async upload(e=""){if(!this.option.url)throw Error("未设置上传地址");if(e&&this.files.has(e))await this.uploadHandle(this.files.get(e));else for(let t of this.files.values())"waiting"!==t.type&&"fail"!==t.type||await this.uploadHandle(t)}addFile(e,t){let s=e.name;if(this.debug&&console.log("文件名称",s,"大小",e.size),e){let t="",i=s.substring(s.lastIndexOf(".")+1).toLowerCase(),l=this.prohibited.formats.toLowerCase();return t=URL.createObjectURL(e),l&&!l.includes(i)?(this.toast(`不支持上传${i.toUpperCase()}格式文件`),!1):e.size>1048576*Math.abs(this.prohibited.size)?(this.toast(`附件大小请勿超过${this.prohibited.size}M`),!1):(this.files.set(e.name,{file:e,path:t,name:e.name,size:e.size,progress:0,type:"waiting"}),!0)}}clear(e=""){return e?this.files.delete(e):this.files.clear(),this.onchange(this.files)}toast(e){i({title:e,icon:"none"})}chooseMessageFile(e,t){wx.chooseMessageFile({count:t,type:e,success:({tempFiles:e})=>{for(let t of e)this.addFile(t);this._uploadAfter()},fail:()=>{this.toast("打开失败")}})}_copyObject(e){return void 0!==e?JSON.parse(JSON.stringify(e)):e}_setValue(e,t,s){let i;i="object"==typeof s?this._copyObject(s):s;let l=new RegExp("([\\w$]+)|\\[(:\\d)\\]","g");const o=t.match(l);for(let a=0;a<o.length-1;a++){let t=o[a];"object"!=typeof e[t]&&(e[t]={}),e=e[t]}e[o[o.length-1]]=i,this.debug&&console.log("参数更新后",JSON.stringify(this.option))}_uploadAfter(){this.onchange(this.files),setTimeout((()=>{this.instantly&&this.upload()}),1e3)}_overrideUrlLoading(){this.dom.overrideUrlLoading({mode:"reject"},(e=>{let{retype:t,item:s,files:i,end:l}=this._getRequest(e.url),o=this;switch(t){case"updateOption":this.dom.evalJS(`vm.setData('${JSON.stringify(o.option)}')`);break;case"change":try{o.files=new Map([...o.files,...JSON.parse(unescape(i))])}catch(a){return console.error("出错了，请检查代码")}o.onchange(o.files);break;case"progress":try{s=JSON.parse(unescape(s))}catch(a){return console.error("出错了，请检查代码")}o._changeFilesItem(s,l)}}))}_getRequest(e){let t=new Object,s=e.indexOf("?");if(-1!=s){let i=e.substring(s+1).split("&");for(let e=0;e<i.length;e++)t[i[e].split("=")[0]]=unescape(i[e].split("=")[1])}return t}_changeFilesItem(e,t=!1){this.debug&&console.log("onprogress",JSON.stringify(e)),this.onprogress(e,t),this.files.set(e.name,e)}_uploadHandle(e){return e.type="loading",delete e.responseText,new Promise(((t,s)=>{this.debug&&console.log("option",JSON.stringify(this.option));let{url:i,name:l,method:o="POST",header:a,formData:n}=this.option,h=new FormData;for(let e in n)h.append(e,n[e]);h.append(l,e.file);let r=new XMLHttpRequest;r.open(o,i,!0);for(let e in a)r.setRequestHeader(e,a[e]);r.upload.addEventListener("progress",(t=>{if(t.lengthComputable){let s=Math.ceil(100*t.loaded/t.total);s<=100&&(e.progress=s,this._changeFilesItem(e))}}),!1),r.ontimeout=()=>(console.error("请求超时"),e.type="fail",this._changeFilesItem(e,!0),t(!1)),r.onreadystatechange=s=>{if(4==r.readyState)return 200==r.status?(this.debug&&console.log("上传完成："+r.responseText),e.responseText=r.responseText,e.type="success",this._changeFilesItem(e,!0),t(!0)):(0==r.status&&console.error("status = 0 :请检查请求头Content-Type与服务端是否匹配，服务端已正确开启跨域，并且nginx未拦截阻止请求"),console.error("--ERROR--：status = "+r.status),e.type="fail",this._changeFilesItem(e,!0),t(!1))},r.send(h)}))}_uploadHandleWX(e){return e.type="loading",delete e.responseText,new Promise(((t,s)=>{this.debug&&console.log("option",JSON.stringify(this.option));let i={filePath:e.file.path,...this.option};i.fail=({errMsg:s=""})=>(console.error("--ERROR--："+s),e.type="fail",this._changeFilesItem(e,!0),t(!1)),i.success=s=>200==s.statusCode?(this.debug&&console.log("上传完成,微信端返回不一定是字符串，根据接口返回格式判断是否需要JSON.parse："+s.data),e.responseText=s.data,e.type="success",this._changeFilesItem(e,!0),t(!0)):(e.type="fail",this._changeFilesItem(e,!0),t(!1)),l(i).onProgressUpdate((({progress:t=0})=>{t<=100&&(e.progress=t,this._changeFilesItem(e))}))}))}}const $=e({name:"Lsj-upload",props:{debug:{type:Boolean,default:!1},instantly:{type:Boolean,default:!1},option:{type:Object,default:()=>{}},size:{type:Number,default:10},count:{type:Number,default:9},multiple:{type:Boolean,default:!0},formats:{type:String,default:""},accept:{type:String,default:""},wxFileType:{type:String,default:"all"},childId:{type:String,default:"lsjUpload"},width:{type:String,default:"100%"},height:{type:String,default:"80rpx"},top:{type:[String,Number],default:""},left:{type:[String,Number],default:""},bottom:{type:[String,Number],default:""},right:{type:[String,Number],default:""},position:{type:String,default:"static"}},data:()=>({}),watch:{option(e){}},updated(){},computed:{getStyles(){let e={width:this.width,height:this.height};return"absolute"==this.position&&(e.top=this.top,e.bottom=this.bottom,e.left=this.left,e.right=this.right,e.position="fixed"),e}},mounted(){this._size=0;let e=this.childId+(new Date).getTime();this.lsjFile=new D({id:e,debug:this.debug,width:this.width,height:this.height,option:this.option,instantly:this.instantly,prohibited:{size:this.size,formats:this.formats,accept:this.accept,count:this.count,multiple:this.multiple},onchange:this.onchange,onprogress:this.onprogress}),this.create(),o("lsjShow",this.show)},beforeDestroy(){a("lsjShow",this.show)},methods:{setFiles(e){if(e instanceof Map)for(let[t,s]of e)s.progress=100,s.type="success",this.lsjFile.files.set(t,s);else Array.isArray(e)&&e.forEach((e=>{e.name&&(e.progress=100,e.type="success",this.lsjFile.files.set(e.name,e))}));this.onchange(this.lsjFile.files)},setData(){this.lsjFile&&this.lsjFile.setData(...arguments)},getDomStyles(e){n().in(this).select(".lsj-file").fields({size:!0,rect:!0},(({height:t,width:s,top:i,left:l,right:o,bottom:a})=>{n().selectViewport().scrollOffset((({scrollTop:o})=>e({top:parseInt(i)+parseInt(o)+"px",left:parseInt(l)+"px",width:parseInt(s)+"px",height:parseInt(t)+"px"}))).exec()})).exec()},show(){this._size&&this._size>=this.count||(this.isShow=!0,this.lsjFile.dom.style.display="inline")},hide(){this.isShow=!1,this.lsjFile.dom.style.display="none"},upload(e){this.lsjFile&&this.lsjFile.upload(e)},onchange(e){return this.$emit("change",e),this._size=e.size,e.size>=this.count?this.hide():this.show()},onprogress(e,t=!1){this.$emit("progress",e),t&&setTimeout((()=>{this.$emit("uploadEnd",e)}),0)},clear(e){this.lsjFile.clear(e)},create(){let e=this.lsjFile.create("/uni_modules/lsj-upload/hybrid/html/uploadFile.html");this.$refs.lsj.$el.appendChild(e),this.show()},onClick(){this._size>=this.count&&this.toast(`只允许上传${this.count}个文件`)},toast(e){i({title:e,icon:"none"})}}},[["render",function(e,t,s,i,l,o){const a=f;return h(),r(a,{class:"lsj-file",style:u([o.getStyles])},{default:d((()=>[p(a,{ref:"lsj",class:"hFile",style:u([o.getStyles]),onClick:o.onClick},{default:d((()=>[c(e.$slots,"default",{},(()=>[p(a,{class:"defview",style:u([o.getStyles])},{default:d((()=>[g("附件上传")])),_:1},8,["style"])]),!0)])),_:3},8,["style","onClick"])])),_:3},8,["style"])}],["__scopeId","data-v-0103ac58"]]);const k=e({data(){var e;return{fileList:[],dateId:"",imageValue:[],option:{url:"http://47.242.234.185:18081/api/v1/investment/upload",name:"file",header:{token:null==(e=m("userInfo"))?void 0:e.token}},accept:"application/pdf",formats:"pdf",debug:!0,files:new Map,btnLoading:!1}},methods:{async toTemplatePage(){if(!this.imageValue.length)return void this.showToastDesc("请进行附件上传");let e=y();e[e.length-2].$vm.getDayQueData(this.imageValue),b({delta:1})},hanldUpload(){this.imageValue.length&&this.showToastDesc("只能上传一个文件")},hanldDelete(e){this.imageValue.map(((t,s)=>{t.path===e.path&&this.imageValue.splice(s,1)}))},showToastDesc(e){this.$refs.uToast.show({message:e,type:"error"})},onuploadEnd(e){if(console.log(`${e.name}已上传结束，上传状态=${e.type}`),e.responseText){console.log("演示服务器返回的字符串JSON转Object对象");const t=JSON.parse(e.responseText);console.log(t,"上传成功的数据"),200===t.code?(this.imageValue.push({name:e.name,url:t.data}),this.btnLoading=!1):this.showToastDesc(t.msg||"上传失败，请重试")}},onprogre(e){this.files.set(e.name,e),console.log("打印对象",JSON.stringify(this.files.get(e.name)))},change(e){const t=JSON.stringify([...e.values()]);if(null==t?void 0:t.length){const e=JSON.parse(t)[0].path,s=JSON.parse(t)[0].name;console.log(e,s,"获取文件url"),this.$refs.lsjUpload.upload(),this.btnLoading=!0}}},onLoad(e){if(e.dayData&&"null"!==e.dayData){const t=JSON.parse(decodeURIComponent(e.dayData));this.imageValue=[{...t}]}const t=setTimeout((()=>{this.imageValue.length&&this.$refs.lsjUpload.hide(),t&&clearTimeout(t)}),600)},watch:{imageValue(e){this.imageValue.length?this.$refs.lsjUpload.hide():this.$refs.lsjUpload.show()}}},[["render",function(e,t,s,i,l,o){const a=_("u-button"),n=w(j("lsj-upload"),$),u=_("u-form-item"),c=_("u--form"),m=_("u-icon"),y=_("u-cell"),b=_("u-cell-group"),x=f,I=_("u-toast");return h(),r(x,{class:"day-que-page"},{default:d((()=>[p(x,{class:"feed-content"},{default:d((()=>[p(c,{ref:"uForm",labelWidth:70},{default:d((()=>[p(u,{label:"附件上传",prop:"fileName",required:""},{default:d((()=>[p(n,{ref:"lsjUpload",childId:"dayUpload",option:l.option,formats:l.formats,debug:l.debug,onUploadEnd:o.onuploadEnd,onProgress:o.onprogre,onChange:o.change,multiple:!1,accept:l.accept},{default:d((()=>[p(a,{type:"primary",onClick:o.hanldUpload,size:"mini",style:{width:"180rpx",height:"30px","margin-top":"10rpx"}},{default:d((()=>[g("选择文件")])),_:1},8,["onClick"])])),_:1},8,["option","formats","debug","onUploadEnd","onProgress","onChange","accept"])])),_:1})])),_:1},512),p(x,{class:"",style:{padding:"24rpx"}},{default:d((()=>[p(b,null,{default:d((()=>[l.imageValue.length?(h(!0),S(F,{key:0},O(l.imageValue,((e,t)=>(h(),r(y,{key:t,title:e.name},{default:d((()=>[p(m,{slot:"right-icon",size:"12",name:"close",onClick:t=>o.hanldDelete(e)},null,8,["onClick"])])),_:2},1032,["title"])))),128)):v("v-if",!0)])),_:1})])),_:1})])),_:1}),p(I,{ref:"uToast"},null,512),p(x,{class:"feed-bottom"},{default:d((()=>[p(a,{text:"完成",type:"primary",onClick:o.toTemplatePage,loading:l.btnLoading},null,8,["onClick","loading"])])),_:1})])),_:1})}]]),J=e(x({__name:"reInvestment",setup(e){const i=I({isNotification:!0,backgroundColor:"#fff",isBack:!0}),l=()=>{};return(e,o)=>{const a=t,n=f,u=C,c=w(j("uni-icons"),s);return h(),r(n,{class:"common-bg"},{default:d((()=>[p(a,N(T(z(i))),null,16),p(n,{class:"verification"},{default:d((()=>[p(n,{class:"title"},{default:d((()=>[g("Re-investment")])),_:1}),p(n,{class:"form"},{default:d((()=>[p(n,{class:"item"},{default:d((()=>[p(n,{class:"name"},{default:d((()=>[g("Download the Application Form")])),_:1}),p(n,{class:"download"},{default:d((()=>[p(n,null,{default:d((()=>[g("Reinvestment.pdf")])),_:1}),p(n,null,{default:d((()=>[p(u,{class:"common-icon",src:U})])),_:1})])),_:1}),v(' <lsj-upload\n            ref="lsjUpload"\n            childId="dayUpload"\n            :option="option"\n            :formats="formats"\n            :debug="debug"\n            @uploadEnd="onuploadEnd"\n            @progress="onprogre"\n            @change="change"\n            :multiple="false"\n            :accept="accept"\n          >\n            <view class="upload">\n              <image class="img" src="../../static/icon/upload.png"></image>\n            </view>\n          </lsj-upload> '),p(k)])),_:1}),p(n,{class:"item"},{default:d((()=>[p(n,{class:"name"},{default:d((()=>[g("Uploaded Files")])),_:1}),p(n,{class:"upload-list"},{default:d((()=>[p(n,null,{default:d((()=>[g("Reinvestment.pdf")])),_:1}),p(n,{class:"close"},{default:d((()=>[p(c,{type:"closeempty",size:12,color:"#828282"})])),_:1})])),_:1})])),_:1})])),_:1}),p(n,{class:"btn",onClick:l},{default:d((()=>[g(" Submit ")])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-7e983269"]]);export{J as default};
